// --- CONFIGURATION ---
const SOURCE_SHEET_ID = '143EspDcO0leMPNnUE_XJIs0YGVjdbVchq5SQMEut2Do'; // The static ID of the spreadsheet containing all strata tabs
const STRATA_PLANS_SHEET_ID = '1ZVW9nVZFqJJ4cIxv6GipZ7oHN_7CryIUiV_hXFF1GI0';
const DESTINATION_SHEET_ID = '15q4fAjDO1U_cSWEGuIdhYn2LZNkcafEYpo6zIYlRRUQ';
const DESTINATION_TAB_NAME = 'Sheet1';

// Column indices (A=1, B=2, C=3, etc.)
const LOT_COLUMN_SRC = 3;
const NAME_ON_TITLE_COL = 6;
const MAIN_CONTACT_COL = 7;
const DEST_LOT_COLUMN = 1;


/**
 * [NEW] Dynamically finds the correct tab name within the static source spreadsheet.
 */
function getSourceSheetInfo(strataPlanNumber) {
  const spreadsheet = SpreadsheetApp.openById(SOURCE_SHEET_ID);
  const allSheets = spreadsheet.getSheets();
  
  for (const sheet of allSheets) {
    const sheetName = sheet.getName();
    // Check if the tab name starts with the strata plan number
    if (sheetName.startsWith(strataPlanNumber)) {
      return {
        id: SOURCE_SHEET_ID,
        tabName: sheetName
      };
    }
  }
  
  return null; // No matching tab found
}


/**
 * Handles all GET requests for the form.
 */
function doGet(e) {
  const action = e.parameter.action || 'getNames';
  
  try {
    // ACTION 1: Get the list of all Strata Plans
    if (action === 'getStrataPlans') {
      const cache = CacheService.getScriptCache();
      const cachedPlans = cache.get('strataPlans');
      if (cachedPlans) {
        return ContentService.createTextOutput(cachedPlans)
          .setMimeType(ContentService.MimeType.JSON);
      }
      
      const sheet = SpreadsheetApp.openById(STRATA_PLANS_SHEET_ID).getSheetByName('Strata Plan List');
      const data = sheet.getRange("A2:B").getValues();
      const plans = data
        .filter(row => row[0])
        .map(row => ({ sp: row[0], suburb: row[1] }));
      
      const json = JSON.stringify({ success: true, plans: plans });
      cache.put('strataPlans', json, 21600); // Cache for 6 hours

      return ContentService.createTextOutput(json)
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // All other actions require a Strata Plan number
    const strataPlanNumber = e.parameter.sp;
    if (!strataPlanNumber) throw new Error("Strata Plan number is required.");
    const sourceInfo = getSourceSheetInfo(strataPlanNumber);
    if (!sourceInfo) throw new Error(`Configuration for Strata Plan ${strataPlanNumber} not found.`);

    // ACTION 2: Get names for a lot number to populate checkbox
    if (action === 'getNames') {
      const lotNumber = e.parameter.lot.trim();
      const sourceSheet = SpreadsheetApp.openById(sourceInfo.id).getSheetByName(sourceInfo.tabName);
      const lotColumnRange = sourceSheet.getRange(1, LOT_COLUMN_SRC, sourceSheet.getLastRow());
      const textFinder = lotColumnRange.createTextFinder(lotNumber).matchEntireCell(true);
      const foundLots = textFinder.findAll();
      let allNames = [];

      for (const lotRange of foundLots) {
        const row = lotRange.getRow();
        const fullNameOnTitle = sourceSheet.getRange(row, NAME_ON_TITLE_COL).getValue().toString().trim();
        const mainContactName = sourceSheet.getRange(row, MAIN_CONTACT_COL).getValue().toString().trim();
        
        let finalNameString = mainContactName;
        const hasTitles = /\b(Mr|Mrs|Ms|Miss)\b/i.test(mainContactName);
        const firstWord = mainContactName.split(' ')[0];
        const firstNameIsInitial = /^[A-Z]\.?$/.test(firstWord);
        if (hasTitles || firstNameIsInitial) finalNameString = fullNameOnTitle;
        
        const isCompany = /\b(P\/L|Pty Ltd|Limited)\b/i.test(finalNameString);
        let parsedNames = [];
        if (isCompany) {
          parsedNames = [finalNameString];
        } else {
          parsedNames = finalNameString.split(/\s+and\s+|\s*&\s*|\s*,\s*/i)
                                 .map(name => name.trim()).filter(name => name);
        }
        allNames.push(...parsedNames);
      }
      
      const uniqueNames = [...new Set(allNames)];
      return ContentService.createTextOutput(JSON.stringify({ success: true, names: uniqueNames }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // Other actions use the destination sheet
    const sheet = SpreadsheetApp.openById(DESTINATION_SHEET_ID).getSheetByName(DESTINATION_TAB_NAME);
    const todaysDateString = Utilities.formatDate(new Date(), "Australia/Sydney", "dd/MM/yyyy");
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
    
    let attendanceCol = -1, nameCol = -1;
    headers.forEach((header, i) => {
      const headerText = String(header);
      if (headerText.includes(todaysDateString)) {
        if (!headerText.includes("Name") && !headerText.includes("Financial")) attendanceCol = i + 1;
        else if (headerText.includes("Name")) nameCol = i + 1;
      }
    });

    // ACTION 3: Get the list of current attendees
    if (action === 'getAttendees') {
      let attendees = [], personCount = 0;
      if (attendanceCol > 0 && nameCol > 0) {
        const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).getValues();
        for (let i = 0; i < data.length; i++) {
          const lot = data[i][DEST_LOT_COLUMN - 1];
          if (!lot) continue;
          
          const attendanceStatus = data[i][attendanceCol - 1];
          const nameData = String(data[i][nameCol - 1]);
          if (attendanceStatus === 'Y') {
            attendees.push({ lot: lot, name: nameData });
            if (!nameData.startsWith("Proxy - Lot")) {
              personCount += (/\b(P\/L|Pty Ltd|Limited)\b/i.test(nameData)) ? 1 : nameData.split(',').length;
            }
          }
        }
      }
      return ContentService.createTextOutput(JSON.stringify({ success: true, attendees: attendees, personCount: personCount }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    // ACTION 4: Get the quorum count
    if (action === 'getQuorum') {
      const lotColumnValues = sheet.getRange("A2:A").getValues();
      const totalLots = lotColumnValues.filter(row => String(row[0]).trim() !== '').length;
      let attendanceCount = 0;
      if (attendanceCol > 0) {
        const attendanceData = sheet.getRange(2, attendanceCol, sheet.getMaxRows()).getValues();
        attendanceCount = attendanceData.filter(cell => String(cell[0]).trim() !== '').length;
      }
      return ContentService.createTextOutput(JSON.stringify({ success: true, attendanceCount: attendanceCount, totalLots: totalLots }))
        .setMimeType(ContentService.MimeType.JSON);
    }

    // ACTION 5: Check if date columns exist
    if (action === 'checkDate') {
      const dateExists = headers.some(header => String(header || '').includes(todaysDateString));
      return ContentService.createTextOutput(JSON.stringify({ success: true, dateExists: dateExists }))
        .setMimeType(ContentService.MimeType.JSON);
    }

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Handles POST requests for submitting and deleting attendance.
 */
function doPost(e) {
  try {
    const submissionData = JSON.parse(e.postData.contents);
    const strataPlanNumber = submissionData.sp;
    if (!strataPlanNumber) throw new Error("Strata Plan number is required for submissions.");

    const action = submissionData.action || 'submit';
    const sheet = SpreadsheetApp.openById(DESTINATION_SHEET_ID).getSheetByName(DESTINATION_TAB_NAME);
    const lotNumber = submissionData.lot;
    const lotColumnRange = sheet.getRange(1, DEST_LOT_COLUMN, sheet.getLastRow());
    const textFinder = lotColumnRange.createTextFinder(lotNumber).matchEntireCell(true);
    const foundLot = textFinder.findNext();

    if (!foundLot) throw new Error(`Lot Number "${lotNumber}" not found in the destination sheet.`);
    const targetRow = foundLot.getRow();

    const dateString = Utilities.formatDate(new Date(), "Australia/Sydney", "dd/MM/yyyy");
    let nameCol, financialCol, attendanceCol;
    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn() + 3).getValues()[0];
    headers.forEach((header, i) => {
      const headerText = String(header);
      if (headerText.includes(dateString)) {
        if (headerText.includes("Name")) nameCol = i + 1;
        else if (headerText.includes("Financial")) financialCol = i + 1;
        else attendanceCol = i + 1;
      }
    });

    if (action === 'delete') {
      if (attendanceCol) sheet.getRange(targetRow, attendanceCol).clearContent();
      if (nameCol) sheet.getRange(targetRow, nameCol).clearContent();
      if (financialCol) sheet.getRange(targetRow, financialCol).clearContent();
      return ContentService.createTextOutput(JSON.stringify({ success: true, message: 'Deletion successful!' }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    const { names, financial, meetingName, companyRep, proxyHolderLot } = submissionData;
    let nameToStore = proxyHolderLot ? `Proxy - Lot ${proxyHolderLot}` : (companyRep ? `${names[0]} - ${companyRep}` : names.join(', '));
    
    const nameHeader = `${dateString} Name`;
    const financialHeader = `${dateString} Financial`;
    let attendanceHeader = meetingName ? `${dateString} ${meetingName.trim()}` : "";
    
    if (attendanceHeader && !attendanceCol) {
      attendanceCol = sheet.getLastColumn() + 1;
      sheet.getRange(1, attendanceCol).setValue(attendanceHeader);
    }
    if (!nameCol) {
      nameCol = sheet.getLastColumn() + 1;
      sheet.getRange(1, nameCol).setValue(nameHeader);
    }
    if (!financialCol) {
      financialCol = sheet.getLastColumn() + 1;
      sheet.getRange(1, financialCol).setValue(financialHeader);
    }
    
    if (attendanceCol > 0) sheet.getRange(targetRow, attendanceCol).setValue('Y');
    if (nameCol > 0) sheet.getRange(targetRow, nameCol).setValue(nameToStore);
    if (financialCol > 0) sheet.getRange(targetRow, financialCol).setValue(financial ? 'Yes' : 'No');
    
    SpreadsheetApp.flush();
    const totalLots = sheet.getRange("A2:A").getValues().filter(row => String(row[0]).trim() !== '').length;
    const attendanceData = sheet.getRange(2, attendanceCol, sheet.getMaxRows()).getValues();
    const attendanceCount = attendanceData.filter(cell => String(cell[0]).trim() !== '').length;

    return ContentService.createTextOutput(JSON.stringify({ 
        success: true, message: 'Submission successful!',
        attendanceCount: attendanceCount, totalLots: totalLots
      }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
