// --- CONFIGURATION ---
const SOURCE_SHEET_ID = '143EspDcO0leMPNnUE_XJIs0YGVjdbVchq5SQMEut2Do';
const SOURCE_TAB_NAME = '77523 Lot Email Addresses';
const DESTINATION_SHEET_ID = '15q4fAjDO1U_cSWEGuIdhYn2LZNkcafEYpo6zIYlRRUQ';
const DESTINATION_TAB_NAME = 'Sheet1';

// Column indices from your source sheet (A=1, B=2, C=3, etc.)
const LOT_COLUMN_SRC = 3;
const NAME_ON_TITLE_COL = 6;
const MAIN_CONTACT_COL = 7;
// Column index for the destination sheet
const DEST_LOT_COLUMN = 1; // Column A

/**
 * [UPDATED] Handles multiple actions: fetching names, and getting the current quorum count.
 */
function doGet(e) {
  const action = e.parameter.action || 'getNames';

  try {
    // ACTION 1: Get the current attendance numbers for the latest meeting
    if (action === 'getQuorum') {
      const sheet = SpreadsheetApp.openById(DESTINATION_SHEET_ID).getSheetByName(DESTINATION_TAB_NAME);
      const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
      const totalLots = sheet.getLastRow() - 1; // Assuming header in row 1, lots start in row 2

      let latestDate = new Date(0);
      let attendanceCol = -1;

      // Find the column for the most recent meeting date
      headers.forEach((header, index) => {
        const match = String(header).match(/(\d{2})\/(\d{2})\/(\d{4})/);
        if (match) {
          const d = new Date(match[3], match[2] - 1, match[1]);
          if (d > latestDate && !String(header).includes("Name") && !String(header).includes("Financial")) {
            latestDate = d;
            attendanceCol = index + 1;
          }
        }
      });

      let attendanceCount = 0;
      if (attendanceCol > 0) {
        const attendanceData = sheet.getRange(2, attendanceCol, sheet.getLastRow()).getValues();
        attendanceCount = attendanceData.filter(cell => String(cell[0]).trim() !== '').length;
      }
      
      return ContentService.createTextOutput(JSON.stringify({ 
          success: true, 
          attendanceCount: attendanceCount,
          totalLots: totalLots 
        }))
        .setMimeType(ContentService.MimeType.JSON);
    }
    
    // ACTION 2 (default): Get names for a lot number
    const lotNumber = e.parameter.lot.trim();
    let allNames = [];
    
    const sheet = SpreadsheetApp.openById(SOURCE_SHEET_ID).getSheetByName(SOURCE_TAB_NAME);
    const lotColumnRange = sheet.getRange(1, LOT_COLUMN_SRC, sheet.getLastRow());
    const textFinder = lotColumnRange.createTextFinder(lotNumber).matchEntireCell(true);
    const foundLots = textFinder.findAll();

    for (const lotRange of foundLots) {
      const row = lotRange.getRow();
      const fullNameOnTitle = sheet.getRange(row, NAME_ON_TITLE_COL).getValue().toString().trim();
      const mainContactName = sheet.getRange(row, MAIN_CONTACT_COL).getValue().toString().trim();
      
      let finalNameString = mainContactName;
      const hasTitles = /\b(Mr|Mrs|Ms|Miss)\b/i.test(mainContactName);
      const firstWord = mainContactName.split(' ')[0];
      const firstNameIsInitial = /^[A-Z]\.?$/.test(firstWord);

      if (hasTitles || firstNameIsInitial) {
        finalNameString = fullNameOnTitle;
      }
      const isCompany = /\b(P\/L|Pty Ltd|Limited)\b/i.test(finalNameString);
      
      let parsedNames = [];
      if (isCompany) {
        parsedNames = [finalNameString];
      } else {
        parsedNames = finalNameString.split(/\s+and\s+|\s*&\s*|\s*,\s*/i)
                               .map(name => name.trim())
                               .filter(name => name);
      }
      allNames.push(...parsedNames);
    }
    
    const uniqueNames = [...new Set(allNames)];
    return ContentService.createTextOutput(JSON.stringify({ success: true, names: uniqueNames }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * [UPDATED] Handles POST requests. Now includes proxy logic and returns quorum data.
 */
function doPost(e) {
  try {
    const submissionData = JSON.parse(e.postData.contents);
    const lotNumber = submissionData.lot;
    const selectedNames = submissionData.names;
    const isFinancial = submissionData.financial;
    const meetingName = submissionData.meetingName;
    const isProxy = submissionData.proxy; // New variable

    const sheet = SpreadsheetApp.openById(DESTINATION_SHEET_ID).getSheetByName(DESTINATION_TAB_NAME);
    const lotColumnRange = sheet.getRange(1, DEST_LOT_COLUMN, sheet.getLastRow());
    const textFinder = lotColumnRange.createTextFinder(lotNumber).matchEntireCell(true);
    const foundLot = textFinder.findNext();

    if (!foundLot) {
      throw new Error(`Lot Number "${lotNumber}" not found in the destination sheet.`);
    }
    
    const targetRow = foundLot.getRow();
    const dateString = Utilities.formatDate(new Date(), "Australia/Sydney", "dd/MM/yyyy");
    
    const nameHeader = `${dateString} Name`;
    const financialHeader = `${dateString} Financial`;
    let attendanceHeader = "";

    if (meetingName) {
      attendanceHeader = `${dateString} ${meetingName}`;
    }

    const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn() + 3).getValues()[0];
    let nameCol = headers.indexOf(nameHeader) + 1;
    let financialCol = headers.indexOf(financialHeader) + 1;
    let attendanceCol = -1;

    if (attendanceHeader) {
      attendanceCol = headers.indexOf(attendanceHeader) + 1;
    } else {
      for (let i = 0; i < headers.length; i++) {
        const headerText = String(headers[i]);
        if (headerText.includes(dateString) && !headerText.includes("Name") && !headerText.includes("Financial")) {
          attendanceCol = i + 1;
          break;
        }
      }
    }
    
    if (attendanceHeader && attendanceCol === 0) {
      attendanceCol = sheet.getLastColumn() + 1;
      sheet.getRange(1, attendanceCol).setValue(attendanceHeader);
    }
    if (nameCol === 0) {
        nameCol = sheet.getLastColumn() + 1;
        sheet.getRange(1, nameCol).setValue(nameHeader);
    }
    if (financialCol === 0) {
        financialCol = sheet.getLastColumn() + 1;
        sheet.getRange(1, financialCol).setValue(financialHeader);
    }
    
    const attendanceValue = isProxy ? 'Proxy' : 'Y'; // Set attendance value
    if (attendanceCol > 0) {
      sheet.getRange(targetRow, attendanceCol).setValue(attendanceValue);
    }
    sheet.getRange(targetRow, nameCol).setValue(selectedNames.join(', '));
    sheet.getRange(targetRow, financialCol).setValue(isFinancial ? 'Yes' : 'No');
    
    // After writing, get the updated quorum count to send back
    SpreadsheetApp.flush(); // Ensure all writes are committed before reading
    const totalLots = sheet.getLastRow() - 1;
    const attendanceData = sheet.getRange(2, attendanceCol, sheet.getLastRow()).getValues();
    const attendanceCount = attendanceData.filter(cell => String(cell[0]).trim() !== '').length;

    return ContentService.createTextOutput(JSON.stringify({ 
        success: true, 
        message: 'Submission successful!',
        attendanceCount: attendanceCount,
        totalLots: totalLots
      }))
      .setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
