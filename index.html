// --- CONFIGURATION ---
const SOURCE_DATA_SHEET_ID = '143EspDcO0leMPNnUE_XJIs0YGVjdbVchq5SQMEut2Do';
const DESTINATION_SHEET_ID = '15q4fAjDO1U_cSWEGuIdhYn2LZNkcafEYpo6zIYlRRUQ';
const DESTINATION_TAB_NAME = 'Sheet1';

// Column indices (A=1, B=2, C=3, etc.)
const LOT_COLUMN_SRC = 3;
const NAME_ON_TITLE_COL = 6;
const MAIN_CONTACT_COL = 7;
const DEST_LOT_COLUMN = 1;


/**
 * Dynamically finds the correct tab name within the static source spreadsheet.
 */
function getSourceSheetInfo(strataPlanNumber) {
  if (!strataPlanNumber) return null;
  const spreadsheet = SpreadsheetApp.openById(SOURCE_DATA_SHEET_ID);
  const allSheets = spreadsheet.getSheets();
  
  for (const sheet of allSheets) {
    const sheetName = sheet.getName();
    if (sheetName.startsWith(strataPlanNumber)) {
      return {
        id: SOURCE_DATA_SHEET_ID,
        tabName: sheetName
      };
    }
  }
  
  return null; // No matching tab found
}

/**
 * [NEW] A centralized function to find the columns for today's meeting.
 */
function getTodaysColumns(sheet) {
  const todaysDateString = Utilities.formatDate(new Date(), "Australia/Sydney", "dd/MM/yyyy");
  const headers = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0];
  let attendanceCol = -1, nameCol = -1, financialCol = -1;

  headers.forEach((header, i) => {
    const headerText = String(header);
    if (headerText.includes(todaysDateString)) {
      if (headerText.includes("Name")) {
        nameCol = i + 1;
      } else if (headerText.includes("Financial")) {
        financialCol = i + 1;
      } else {
        attendanceCol = i + 1;
      }
    }
  });
  return { attendanceCol, nameCol, financialCol, todaysDateString };
}


/**
 * Handles all GET requests for the form.
 */
function doGet(e) {
  const action = e.parameter.action || 'getNames';
  
  try {
    // ACTION 1: Get the list of all Strata Plans
    if (action === 'getStrataPlans') {
      const cache = CacheService.getScriptCache();
      const cachedPlans = cache.get('strataPlans');
      if (cachedPlans) return ContentService.createTextOutput(cachedPlans).setMimeType(ContentService.MimeType.JSON);
      
      const spreadsheet = SpreadsheetApp.openById(SOURCE_DATA_SHEET_ID);
      const sheet = spreadsheet.getSheetByName('Strata Plan List');
      if (!sheet) throw new Error("Could not find the 'Strata Plan List' tab.");

      const lastRow = sheet.getLastRow();
      const data = sheet.getRange(2, 1, lastRow > 1 ? lastRow - 1 : 1, 2).getValues();
      const plans = data.filter(row => row[0]).map(row => ({ sp: row[0], suburb: row[1] }));
      
      const json = JSON.stringify({ success: true, plans: plans });
      cache.put('strataPlans', json, 21600);
      return ContentService.createTextOutput(json).setMimeType(ContentService.MimeType.JSON);
    }
    
    const strataPlanNumber = e.parameter.sp;
    const sourceInfo = getSourceSheetInfo(strataPlanNumber);
    if (!sourceInfo) throw new Error(`Data sheet for Strata Plan ${strataPlanNumber} not found.`);

    // ACTION 2: Get names for a lot number
    if (action === 'getNames') {
      const lotNumber = e.parameter.lot.trim();
      const sourceSheet = SpreadsheetApp.openById(sourceInfo.id).getSheetByName(sourceInfo.tabName);
      const lotColumnRange = sourceSheet.getRange(1, LOT_COLUMN_SRC, sourceSheet.getLastRow());
      const textFinder = lotColumnRange.createTextFinder(lotNumber).matchEntireCell(true);
      const foundLots = textFinder.findAll();
      let allNames = [];

      for (const lotRange of foundLots) {
        const row = lotRange.getRow();
        const fullNameOnTitle = sourceSheet.getRange(row, NAME_ON_TITLE_COL).getValue().toString().trim();
        const mainContactName = sourceSheet.getRange(row, MAIN_CONTACT_COL).getValue().toString().trim();
        
        let finalNameString = mainContactName;
        const hasTitles = /\b(Mr|Mrs|Ms|Miss)\b/i.test(mainContactName);
        const firstWord = mainContactName.split(' ')[0];
        const firstNameIsInitial = /^[A-Z]\.?$/.test(firstWord);
        if (hasTitles || firstNameIsInitial) finalNameString = fullNameOnTitle;
        
        const isCompany = /\b(P\/L|Pty Ltd|Limited)\b/i.test(finalNameString);
        let parsedNames = isCompany ? [finalNameString] : finalNameString.split(/\s+and\s+|\s*&\s*|\s*,\s*/i).map(name => name.trim()).filter(name => name);
        allNames.push(...parsedNames);
      }
      
      return ContentService.createTextOutput(JSON.stringify({ success: true, names: [...new Set(allNames)] })).setMimeType(ContentService.MimeType.JSON);
    }
    
    const sheet = SpreadsheetApp.openById(DESTINATION_SHEET_ID).getSheetByName(DESTINATION_TAB_NAME);
    const { attendanceCol, nameCol } = getTodaysColumns(sheet);

    // ACTION 3: Get the list of current attendees
    if (action === 'getAttendees') {
      let attendees = [], personCount = 0;
      if (attendanceCol > 0 && nameCol > 0) {
        const data = sheet.getRange(2, 1, sheet.getLastRow() - 1, sheet.getLastColumn()).getValues();
        for (const row of data) {
          if (!row[DEST_LOT_COLUMN - 1]) continue;
          
          if (row[attendanceCol - 1] === 'Y') {
            const nameData = String(row[nameCol - 1]);
            attendees.push({ lot: row[DEST_LOT_COLUMN - 1], name: nameData });
            if (!nameData.startsWith("Proxy - Lot")) {
              personCount += (/\b(P\/L|Pty Ltd|Limited)\b/i.test(nameData)) ? 1 : nameData.split(',').length;
            }
          }
        }
      }
      return ContentService.createTextOutput(JSON.stringify({ success: true, attendees, personCount })).setMimeType(ContentService.MimeType.JSON);
    }

    // ACTION 4: Get the quorum count
    if (action === 'getQuorum') {
      const lotColumnValues = sheet.getRange("A2:A").getValues();
      const totalLots = lotColumnValues.filter(row => String(row[0]).trim() !== '').length;
      let attendanceCount = 0;
      if (attendanceCol > 0) {
        const attendanceData = sheet.getRange(2, attendanceCol, sheet.getMaxRows()).getValues();
        attendanceCount = attendanceData.filter(cell => String(cell[0]).trim() !== '').length;
      }
      return ContentService.createTextOutput(JSON.stringify({ success: true, attendanceCount, totalLots })).setMimeType(ContentService.MimeType.JSON);
    }

    // ACTION 5: Check if date columns exist
    if (action === 'checkDate') {
      const { todaysDateString } = getTodaysColumns(sheet); // Use the helper
      const dateExists = sheet.getRange(1, 1, 1, sheet.getLastColumn()).getValues()[0]
                            .some(header => String(header || '').includes(todaysDateString));
      return ContentService.createTextOutput(JSON.stringify({ success: true, dateExists })).setMimeType(ContentService.MimeType.JSON);
    }

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}

/**
 * Handles POST requests for submitting and deleting attendance.
 */
function doPost(e) {
  try {
    const submissionData = JSON.parse(e.postData.contents);
    const strataPlanNumber = submissionData.sp;
    if (!strataPlanNumber) throw new Error("Strata Plan number is required for submissions.");

    const action = submissionData.action || 'submit';
    const sheet = SpreadsheetApp.openById(DESTINATION_SHEET_ID).getSheetByName(DESTINATION_TAB_NAME);
    const lotNumber = submissionData.lot;
    const lotColumnRange = sheet.getRange(1, DEST_LOT_COLUMN, sheet.getLastRow());
    const textFinder = lotColumnRange.createTextFinder(lotNumber).matchEntireCell(true);
    const foundLot = textFinder.findNext();

    if (!foundLot) throw new Error(`Lot Number "${lotNumber}" not found in the destination sheet.`);
    const targetRow = foundLot.getRow();

    let { attendanceCol, nameCol, financialCol, todaysDateString } = getTodaysColumns(sheet);

    if (action === 'delete') {
      if (attendanceCol > 0) sheet.getRange(targetRow, attendanceCol).clearContent();
      if (nameCol > 0) sheet.getRange(targetRow, nameCol).clearContent();
      if (financialCol > 0) sheet.getRange(targetRow, financialCol).clearContent();
      return ContentService.createTextOutput(JSON.stringify({ success: true, message: 'Deletion successful!' })).setMimeType(ContentService.MimeType.JSON);
    }
    
    const { names, financial, meetingName, companyRep, proxyHolderLot } = submissionData;
    let nameToStore = proxyHolderLot ? `Proxy - Lot ${proxyHolderLot}` : (companyRep ? `${names[0]} - ${companyRep}` : names.join(', '));
    
    // Create columns if they don't exist
    if (meetingName) {
      const attendanceHeader = `${todaysDateString} ${meetingName.trim()}`;
      if (!attendanceCol) {
        attendanceCol = sheet.getLastColumn() + 1;
        sheet.getRange(1, attendanceCol).setValue(attendanceHeader);
      }
    }
    if (!nameCol) {
      const nameHeader = `${todaysDateString} Name`;
      nameCol = sheet.getLastColumn() + 1;
      sheet.getRange(1, nameCol).setValue(nameHeader);
    }
    if (!financialCol) {
      const financialHeader = `${todaysDateString} Financial`;
      financialCol = sheet.getLastColumn() + 1;
      sheet.getRange(1, financialCol).setValue(financialHeader);
    }
    
    if (attendanceCol > 0) sheet.getRange(targetRow, attendanceCol).setValue('Y');
    if (nameCol > 0) sheet.getRange(targetRow, nameCol).setValue(nameToStore);
    if (financialCol > 0) sheet.getRange(targetRow, financialCol).setValue(financial ? 'Yes' : 'No');
    
    SpreadsheetApp.flush();
    const totalLots = sheet.getRange("A2:A").getValues().filter(row => String(row[0]).trim() !== '').length;
    const attendanceData = sheet.getRange(2, attendanceCol, sheet.getMaxRows()).getValues();
    const attendanceCount = attendanceData.filter(cell => String(cell[0]).trim() !== '').length;

    return ContentService.createTextOutput(JSON.stringify({ 
        success: true, message: 'Submission successful!',
        attendanceCount: attendanceCount, totalLots: totalLots
      })).setMimeType(ContentService.MimeType.JSON);

  } catch (error) {
    return ContentService.createTextOutput(JSON.stringify({ success: false, error: error.toString() }))
      .setMimeType(ContentService.MimeType.JSON);
  }
}
